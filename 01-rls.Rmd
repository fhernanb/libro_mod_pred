# Regresión lineal simple {#rls}
En este capítulo se presenta una descripción breve del modelo de regresión lineal simple y la forma de estimar los parámetros del modelo con R.

## Modelo estadístico {-}
El modelo estadístico en regresión lineal simple se puede escribir de dos formas como se muestra a continuación.

1. En esta forma la variable respuesta $y$ se expresa como una suma de $\beta_0 + \beta_1 x_i$ y un error aleatorio $e_i$ el cual tiene distribución $N(0, \sigma^2)$. El modelo en esta forma se puede expresar como sigue.

\begin{align} \label{mod1}
y_i &= \beta_0 + \beta_1 x_i + e_i, \\ 
e_i &\sim N(0, \sigma^2)
\end{align}

2. En esta forma la variable respuesta $y$ tiene distribución normal con media que cambia en función de la variable $x$ pero con varianza constante. El modelo en esta forma se puede expresar como sigue.

\begin{align} \label{mod2}
y_i &\sim N(\mu_i, \sigma^2), \\ 
\mu_i &= \beta_0 + \beta_1 x_i, \\
\sigma^2 &= \text{constante}
\end{align}

En cualquiera de las dos formas el vector de parámetros del modelo es $\boldsymbol{\theta}=(\beta_0, \beta_1, \sigma)^\top$. 

## Función `lm` {-}
La función `lm` de R se usa para ajustar un modelo de regresión lineal simple, la estructura de esta función se muestra a continuación.

```{r, eval=FALSE}
lm(formula, data, subset, weights, na.action,
   method = "qr", model = TRUE, x = FALSE, y = FALSE, qr = TRUE,
   singular.ok = TRUE, contrasts = NULL, offset, ...)
```

A continuación se presenta una corta descripción de los parámetros más usados en la función.

- `formula`: es un objeto de la clase fórmula para indicar la variable respuesta y las covariables. Por ejemplo, si `formula = y ~ x1 + x2` lo que se indica es que la variable respuesta es `y`, las covariables serían `x1` y `x2`.
- `data`: es el marco de datos donde se buscarán las variables usadas en la fórmula. Si este parámetro queda vacío, R buscará las variables en el ambiente global.

### Ejemplo {-}
Como ilustración vamos a usar los datos del ejemplo 2.1 del libro de [Montgomery, Peck and Vining (2003)](https://www.amazon.com/Introduccion-analisis-regresion-lineal-Spanish/dp/9702403278). En el ejemplo 2.1 los autores ajustaron un modelo de regresión lineal simple para explicar la Resistencia de una soldadura en función de la Edad de la misma. 

A continuación el código para cargar los datos y una muestra de las 6 primeras observaciones de la base de datos, en total tenemos 20 observaciones.

```{r}
file <- "https://raw.githubusercontent.com/fhernanb/datos/master/propelente"
datos <- read.table(file=file, header=TRUE)
head(datos) # shows the first 6 rows
```

Para crear un diagrama de dispersión que nos muestre la relación entre las dos variables usamos las siguientes instrucciones.

```{r soldadura1, fig.height=3, fig.width=5, fig.align='center', message=FALSE}
library(ggplot2)
ggplot(datos, aes(x=Edad, y=Resistencia)) + 
  geom_point() + theme_light()
```

De la figura anterior se ve claramente que a medida que aumenta la edad de la soldadura, la resistencia que ella ofrece disminuye. Adicionalmente, se observa que la relación entre las variables es lineal con una dispersión que parece constante.

El modelo que se va a ajustar se muestra a continuación.

\begin{align}
Resistencia_i &\sim N(\mu_i, \sigma^2), \\ 
\mu_i &= \beta_0 + \beta_1 Edad_i, \\
\sigma^2 &= \text{constante}
\end{align}

Para obtener las estimaciones de los parámetros del modelo anterior se usa el código mostrado abajo. La función `lm` se aplica con la fórmula `Resistencia ~ Edad` para indicar que Resistencia es la variable respuesta y que Edad es la variable explicativa. Los resultados del la función `lm` se almacenan en el objeto `mod1` para luego poder usar el modelo ajustado. La segunda línea del código mostrado abajo se usa para mostrar por pantalla un reporte sencillo del modelo ajustado.

```{r}
mod1 <- lm(Resistencia ~ Edad, data=datos)
mod1 # Para imprimir el objeto mod1
```

En la salida anterior se observan los valores estimados de $\beta_0$ y $\beta_1$ pero no aparece la estimación de $\sigma$. Para obtener una tabla de resumen con detalles del modelo ajustado, se usa la función genérica `summary`, a continuación el código necesario para obtener la tabla.

```{r, eval=FALSE}
summary(mod1)
```

La siguiente figura muestra el resultado del código anterior. En la figura se resalta la información sobre los residuales y las estimaciones de $\beta_0$, $\beta_1$ y $\sigma$.

```{r summary01, echo=F, fig.cap='Tabla de resumen para un modelo lineal.', dpi=80, fig.align='center'}
knitr::include_graphics("images/summary01.png")
```

Con los resultados anteriores se puede expresar el modelo ajustado como se muestra a continuación.

\begin{align}
\widehat{Resistencia}_i &\sim N(\hat{\mu}_i, \hat{\sigma}^2), \\ 
\hat{\mu}_i &= 2627.822 -37.154 \, Edad_i, \\
\hat{\sigma} &= 96.11
\end{align}

Para incluir la recta de regresión que representa el modelo ajustado anterior se puede usar el siguiente código.

```{r soldadura2, fig.height=3, fig.width=5, fig.align='center'}
ggplot(datos, aes(x=Edad, y=Resistencia)) + 
  geom_point() +
  geom_smooth(method='lm', formula=y~x, se=FALSE, col='dodgerblue1') +
  theme_light()
```

## Clase `lm` {-}
Todo objeto creado con la función `lm( )` es de la clase **lm**, para verificar esto podemos escribir lo siguiente en la consola.

```{r}
class(mod1)
```

Dentro de todo objeto de la clase **lm** hay doce elementos o valores que se pueden utilizar. A continuación se muestra el código para saber los nombres de esos elementos.

```{r}
names(mod1)
```

Cualquiera de los anteriores elementos se pueden extraer usando el operador `$` entre el objeto y el elemento, por ejemplo, para extraer los coeficientes estimados se escribe lo siguiente:

```{r}
mod1$coefficients
```

Los nombres de los elementos dan una idea clara de lo que ellos almacenan, si el lector quiere más detalles sobre los elementos, sólo debe solicitar la ayuda de la función con `help(lm)` y en la sección de __Value__ encontrará la información.

En el siguiente código se utiliza para extraer el elemento `$fitted.value` que contiene los valores predichos o ajustados $\hat{y}_i$.

```{r}
mod1$fitted.values
```

A continuación se muestra el código para extraer el elemento `$residuals` que contiene los residuales usuales $e_i= y_i - \hat{y}_i$.

```{r}
mod1$residuals
```

```{block2, type='rmdnote'}
Los valores ajustados y los residuales también se pueden recuperar usando las funciones `fitted( )` y `residuals( )`. Consulte la ayuda de estas funciones para conocer otros detalles.
```

### Ejemplo {-}
Aquí se retoma el ejemplo de Resistencia en función de la Edad. El objetivo es crear una diagrama de dispersión con los puntos originales $(x_i, y_i)$, las estimaciones $\hat{y}_i$ y los residuales $e_i$.

Lo primero que se debe hacer es agregar a los datos originales el vector con las estimaciones $\hat{y}_i$, el código necesario se muestra a continuación.

```{r}
datos$predicciones <- predict(mod1)
```

En el diagrama dispersión los puntos originales $(x_i, y_i)$ estarán en color negro y los puntos correspondientes a las estimaciones $(x_i, \hat{y}_i)$ estarán en color rojo, estos últimos coincidirán con la recta estimada en color gris. Los residuales $e_i$ se mostrarán como líneas a trazos de color rojo. El código necesario se muestra a continuación.

```{r soldadura3, fig.height=3, fig.width=5, fig.align='center'}
ggplot(datos, aes(x=Edad, y=Resistencia)) +
  geom_smooth(method="lm", se=FALSE, color="lightgrey") +
  geom_segment(aes(xend=Edad, yend=predicciones), col='red', lty='dashed') +
  geom_point() +
  geom_point(aes(y=predicciones), col='red') +
  theme_light()
```


